# AUTOMATICALLY GENERATED BY PUPPET : DO NOT EDIT

# Exim 4 configuration for smarthost delivery
acl_smtp_rcpt = check_recipient
acl_smtp_data = check_message

log_selector =  \
              +received_sender \
              +received_recipients \
              +smtp_confirmation

qualify_domain = <%= @qualify_domain %>
allow_domain_literals = false
never_users = root
gecos_pattern = ^
gecos_name = ""
local_interfaces = "<%= @listen_interfaces.join(' : ') %>"
# Allow localhost to use unqualified names, saving on typing:
sender_unqualified_hosts = localhost
recipient_unqualified_hosts = localhost


####################################################################### ACLs ###
begin acl

# ACL that is used after the RCPT command
check_recipient:
<% if @dkim_disable_verify -%>
  # This is to work around a critical remote-code-execution bug in 
  #  versions 4.70 < 4.82 (4.80-5.1 on Debian):
  warn control = dkim_disable_verify
<% end -%>
  # Exim 3 had no checking on -bs messages, so for compatibility
  # we accept if the source is local SMTP (i.e. not over TCP/IP).
  # We do this by testing for an empty sending host field.
  accept  hosts = :
  accept  hosts = <%= @accept_hosts.join(' : ') %>
  deny    message = relay not permitted

# ACL that is used after the DATA command
check_message:
  accept


#################################################################### routers ###
begin routers

# Just direct delivery for all domains (nothing delivered locally)
<% if @direct_delivery -%>
dnslookup:
  driver = dnslookup
  transport = remote_smtp
  ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8
  no_more
<% else -%>
smarthost:
  driver = manualroute
  domains = *
  transport = remote_smtp
  route_data = "<%= @smarthost %>"
<% end -%>



################################################################# transports ###
begin transports

remote_smtp:
  driver = smtp
  port = <%= @port %>
  helo_data = <%= @fqdn %>


###################################################################### retry ###
begin retry

# Domain               Error       Retries
# ------               -----       -------

*                      *           F,2h,15m; F,16h,1h; F,4d,4h


################################################################### rewrites ###
begin rewrite

# Redirect anything root-like (to and from)

<% @redirect_root_usernames.each do |u| -%>
<%= u %>@localhost                              <%= @redirect_root %>
<%= u %>@<%= @qualify_domain %>   <%= @redirect_root %>
<%= u %>@<%= @hostname %>         <%= @redirect_root %>
<%= u %>@<%= @fqdn %>             <%= @redirect_root %>
<%     @extra_hostnames.each do |h| -%>
<%=      u %>@<%= h %>                          <%= @redirect_root %>
<%     end -%>
<% end -%>

<% if @rewrites and ! @rewrites.empty? -%>
<%   @rewrites.each do |key,value| -%>
<%     unless value.empty? -%>
<%=        key -%>                              <%= value %>
<%     end -%>
<%   end -%>
<% end -%>

# End of Exim 4 configuration
